/**
 * 
 */
var tempFlaskEvent = {"EventDetails":[{"EventDetail":"{\"addrLine1\":\"\",\"addrLine2\":\"\",\"city\":\"\",\"companyId\":20154,\"cost\":0.0,\"countryId\":0,\"countryName\":\"\",\"createdDate\":1440163841000,\"eventDetailId\":32955,\"eventId\":32933,\"hoursOfOperation\":\"\",\"infoDesc\":\"This is going to be a very entertaining game both these teams aren't quite the best but definitely are a force to be reckoned with\",\"infoTitle\":\"This game gona Rock..\",\"infoTypeCategoryId\":1,\"infoTypeCategoryName\":\"General\",\"infoTypeId\":1,\"infoTypeName\":\"General\",\"latitude\":\"0\",\"longitude\":\"0\",\"modifiedDate\":1440163841000,\"phone\":\"\",\"stateId\":0,\"stateName\":\"\",\"userId\":20198,\"website\":\"\",\"zipCode\":\"\"}","EventDetailImages":[{"EventDetailImage":"{\"companyId\":20154,\"createdDate\":1440163846000,\"eventDetailId\":32955,\"eventDetailImageId\":32970,\"imageDesc\":\"32955_alg_lions-celebrate1.jpg\",\"imageGroupId\":20181,\"imageTitle\":\"32955_alg_lions-celebrate1.jpg\",\"imageUUID\":\"835b0e16-f4b6-4658-9a09-6ee635631ed8\",\"modifiedDate\":1440163846000,\"userId\":20198}"},{"EventDetailImage":"{\"companyId\":20154,\"createdDate\":1440163849000,\"eventDetailId\":32955,\"eventDetailImageId\":32987,\"imageDesc\":\"32955_Lions-grading-week-1.jpg\",\"imageGroupId\":20181,\"imageTitle\":\"32955_Lions-grading-week-1.jpg\",\"imageUUID\":\"34b07e4c-c74c-43cc-aca7-ec9d8b1c0232\",\"modifiedDate\":1440163849000,\"userId\":20198}"}]},{"EventDetail":"{\"addrLine1\":\"\",\"addrLine2\":\"\",\"city\":\"\",\"companyId\":20154,\"cost\":0.0,\"countryId\":0,\"countryName\":\"\",\"createdDate\":1441007789000,\"eventDetailId\":36717,\"eventId\":32933,\"hoursOfOperation\":\"\",\"infoDesc\":\"Tradition Info Description Goes Here...\",\"infoTitle\":\"Tradition Info\",\"infoTypeCategoryId\":2,\"infoTypeCategoryName\":\"Tradition\",\"infoTypeId\":2,\"infoTypeName\":\"Pre-Event\",\"latitude\":\"0\",\"longitude\":\"0\",\"modifiedDate\":1441007789000,\"phone\":\"\",\"stateId\":0,\"stateName\":\"\",\"userId\":20198,\"website\":\"\",\"zipCode\":\"\"}","EventDetailImages":[{"EventDetailImage":"{\"companyId\":20154,\"createdDate\":1441007795000,\"eventDetailId\":36717,\"eventDetailImageId\":36730,\"imageDesc\":\"36717_staticmap.png\",\"imageGroupId\":20181,\"imageTitle\":\"36717_staticmap.png\",\"imageUUID\":\"50cfc725-b3b5-4aca-b5e1-96616d4ca7b6\",\"modifiedDate\":1441007795000,\"userId\":20198}"}]},{"EventDetail":"{\"addrLine1\":\"\",\"addrLine2\":\"\",\"city\":\"\",\"companyId\":20154,\"cost\":0.0,\"countryId\":0,\"countryName\":\"\",\"createdDate\":1441007872000,\"eventDetailId\":36735,\"eventId\":32933,\"hoursOfOperation\":\"\",\"infoDesc\":\"Traffic Info Descritpion Goes here...\",\"infoTitle\":\"Traffic Info\",\"infoTypeCategoryId\":5,\"infoTypeCategoryName\":\"Traffic\",\"infoTypeId\":3,\"infoTypeName\":\"During-Event\",\"latitude\":\"0\",\"longitude\":\"0\",\"modifiedDate\":1441007872000,\"phone\":\"\",\"stateId\":0,\"stateName\":\"\",\"userId\":20198,\"website\":\"\",\"zipCode\":\"\"}","EventDetailImages":[]},{"EventDetail":"{\"addrLine1\":\"\",\"addrLine2\":\"\",\"city\":\"\",\"companyId\":20154,\"cost\":0.0,\"countryId\":0,\"countryName\":\"\",\"createdDate\":1441007944000,\"eventDetailId\":36737,\"eventId\":32933,\"hoursOfOperation\":\"\",\"infoDesc\":\"Post event General Category Information Description goes over here..\",\"infoTitle\":\"Post event General Info\",\"infoTypeCategoryId\":1,\"infoTypeCategoryName\":\"General\",\"infoTypeId\":4,\"infoTypeName\":\"Post-Event\",\"latitude\":\"0\",\"longitude\":\"0\",\"modifiedDate\":1441007944000,\"phone\":\"\",\"stateId\":0,\"stateName\":\"\",\"userId\":20198,\"website\":\"\",\"zipCode\":\"\"}","EventDetailImages":[{"EventDetailImage":"{\"companyId\":20154,\"createdDate\":1441007945000,\"eventDetailId\":36737,\"eventDetailImageId\":36749,\"imageDesc\":\"36737_staticmap.png\",\"imageGroupId\":20181,\"imageTitle\":\"36737_staticmap.png\",\"imageUUID\":\"c82dd028-9280-45ff-b7c5-265451896267\",\"modifiedDate\":1441007945000,\"userId\":20198}"}]},{"EventDetail":"{\"addrLine1\":\"\",\"addrLine2\":\"\",\"city\":\"\",\"companyId\":20154,\"cost\":0.0,\"countryId\":0,\"countryName\":\"\",\"createdDate\":1441007989000,\"eventDetailId\":36754,\"eventId\":32933,\"hoursOfOperation\":\"\",\"infoDesc\":\"Description\",\"infoTitle\":\"Title\",\"infoTypeCategoryId\":1,\"infoTypeCategoryName\":\"General\",\"infoTypeId\":4,\"infoTypeName\":\"Post-Event\",\"latitude\":\"0\",\"longitude\":\"0\",\"modifiedDate\":1441007989000,\"phone\":\"\",\"stateId\":0,\"stateName\":\"\",\"userId\":20198,\"website\":\"\",\"zipCode\":\"\"}","EventDetailImages":[{"EventDetailImage":"{\"companyId\":20154,\"createdDate\":1441007990000,\"eventDetailId\":36754,\"eventDetailImageId\":36766,\"imageDesc\":\"36754_staticmap.png\",\"imageGroupId\":20181,\"imageTitle\":\"36754_staticmap.png\",\"imageUUID\":\"9142e743-0679-4e3b-a58f-008754550f66\",\"modifiedDate\":1441007990000,\"userId\":20198}"}]},{"EventDetail":"{\"addrLine1\":\"\",\"addrLine2\":\"\",\"city\":\"\",\"companyId\":20154,\"cost\":0.0,\"countryId\":0,\"countryName\":\"\",\"createdDate\":1441013381000,\"eventDetailId\":36905,\"eventId\":32933,\"hoursOfOperation\":\"\",\"infoDesc\":\"General Info Category type Description\",\"infoTitle\":\"Second General Info\",\"infoTypeCategoryId\":1,\"infoTypeCategoryName\":\"General\",\"infoTypeId\":1,\"infoTypeName\":\"General\",\"latitude\":\"0\",\"longitude\":\"0\",\"modifiedDate\":1441013381000,\"phone\":\"\",\"stateId\":0,\"stateName\":\"\",\"userId\":20198,\"website\":\"\",\"zipCode\":\"\"}","EventDetailImages":[{"EventDetailImage":"{\"companyId\":20154,\"createdDate\":1441013382000,\"eventDetailId\":36905,\"eventDetailImageId\":36922,\"imageDesc\":\"36905_fff.png\",\"imageGroupId\":20181,\"imageTitle\":\"36905_fff.png\",\"imageUUID\":\"23fad5a2-83eb-484c-a400-726d497102e2\",\"modifiedDate\":1441013382000,\"userId\":20198}"}]}],"Event":"{\"companyId\":20154,\"createdDate\":1440163689000,\"description\":\"Detroit Lions @ San Diego Chargers\",\"endTime\":1440118800000,\"eventDate\":1440115200000,\"eventId\":32933,\"eventImageGroupId\":20181,\"eventImageUUID\":\"41015601-b50d-433d-8c9d-f60b1f28837f\",\"eventName\":\"Detroit Lions @ San Diego Chargers\",\"eventTypeId\":1,\"eventTypeName\":\"Football\",\"modifiedDate\":1440164030000,\"startTime\":1440101100000,\"userId\":20198,\"venueId\":31665,\"venueName\":\"Ford Field\"}"};
var flask_export = {};
flask_export.exportEventAsPDF = function exportEventAsPDF(flaskEvent) {
	var tempEvent = jQuery.parseJSON(flaskEvent.Event);
	flaskEvent.Event = tempEvent;
	var pdf = new jsPDF('p', 'pt', 'letter');
	pdf.setFontSize(12);
	pdf.setFont("times");
	addEventInfo(flaskEvent, pdf, addEventGeneralInfo);
}
//Add Event General Info
function addEventGeneralInfo(flaskEvent, pdf){
	var date = new Date(flaskEvent.Event.eventDate);
	var eventDate = date.getMonth() + "/" + date.getDate() + "/"
			+ date.getFullYear();
	date = new Date(flaskEvent.Event.startTime);
	var startTime = date.getHours() + ":" + date.getMinutes();
	date = new Date(flaskEvent.Event.endTime);
	var endTime = date.getHours() + ":" + date.getMinutes();
	pdf.text(20, 110, "Event Name    : ");
	pdf.text(120, 110, flaskEvent.Event.eventName);
	pdf.text(20, 130, "Description     : " );
	pdf.text(120, 130, flaskEvent.Event.description);
	pdf.text(20, 150, "Event Date      : ");
	pdf.text(120, 150, eventDate);
	pdf.text(20,170,  "Start Time      : ");
	pdf.text(120, 170, convert24HourToAMPM(startTime));
	pdf.text(20, 190, "End Time        : ");
	pdf.text(120, 190, convert24HourToAMPM(endTime));
	pdf.text(20, 210, "Venue Name    : ");
	pdf.text(120, 210, flaskEvent.Event.venueName);
	pdf.addPage();
	var eventCategoryDetailsArray = prepareCategoryWisedEventDetails(flaskEvent.EventDetails);
	addEventDetails(eventCategoryDetailsArray, pdf, createPDF);
}

// Add Event Info
function addEventInfo(event,pdf, callback){
	var imgURL = _flaskLib.UTILITY.IMAGES_PATH + "?uuid="+event.Event.eventImageUUID+"&groupId="+event.Event.eventImageGroupId;

	var logoLocation = {x:250, y:40, h:50, w:50	};
	var img = new Image();

	img.onError = function() {
		alert('Cannot load image: "' + url + '"');
	};
	img.onload = function() {
		pdf.addImage(img, 'JPEG', logoLocation.x, logoLocation.y, logoLocation.w, logoLocation.h, 'eventLogo');
		callback(event, pdf);
	};
	img.src = imgURL;
//	getImageFromUrlAndAddToPDF(imgURL,pdf,logoLocation);
}
// Prepare Info Category wised Event Detials OBJ
function prepareCategoryWisedEventDetails(eventDetails){
	var eventCategoryDetailsArray = {general:[],preEvent:[],postEvent:[],duringEvent:[]};
	for(var i = 0 ; i < eventDetails.length ; i++){
		var eventDetailsInfo = eventDetails[i];
		eventDetailsInfo.EventDetail = jQuery.parseJSON(eventDetailsInfo.EventDetail);
		if(eventDetailsInfo.EventDetail.infoTypeName == "General")
			eventCategoryDetailsArray.general.push(eventDetailsInfo);
		else if(eventDetailsInfo.EventDetail.infoTypeName == "Pre-Event")
			eventCategoryDetailsArray.preEvent.push(eventDetailsInfo);
		else if(eventDetailsInfo.EventDetail.infoTypeName == "Post-Event")
			eventCategoryDetailsArray.postEvent.push(eventDetailsInfo);
		else if(eventDetailsInfo.EventDetail.infoTypeName == "During-Event")
			eventCategoryDetailsArray.duringEvent.push(eventDetailsInfo);
	}
	return eventCategoryDetailsArray;
}

// Add Event Details 
function addEventDetails(eventCategoryDetailsArray, pdf, callback){
	var x = 20, y = 20;
	pdf.setFontSize(16);
	pdf.text(250, y, "Event Details");
	y = y + 20;
	if(eventCategoryDetailsArray.general.length > 0){
		pdf.setFontSize(14);
		pdf.text(x,y, "General");
		y = y+20;
	}
	for(var i = 0 ; i < eventCategoryDetailsArray.general.length ; i++){
		var generalEventDetailInfo = eventCategoryDetailsArray.general[i];
		pdf.setFontSize(13);
		pdf.text(30, y, "("+(i+1)+") "+generalEventDetailInfo.EventDetail.infoTypeCategoryName);
		y = y + 20;
		var line = pdf.setFontSize(12).splitTextToSize("Title : " + generalEventDetailInfo.EventDetail.infoTitle, 500);
		pdf.text(40, y, line);
		y = y+20;
		line = pdf.setFontSize(12).splitTextToSize("Description : " + generalEventDetailInfo.EventDetail.infoDesc, 500);
		pdf.text(40, y, line);
		y = y+20;
		var xAxis = x + 20;
		for(var j = 0 ; j < generalEventDetailInfo.EventDetailImages.length; j++){
			var generalEventDetailImg = generalEventDetailInfo.EventDetailImages[j];
			generalEventDetailImg.EventDetailImage = jQuery.parseJSON(generalEventDetailImg.EventDetailImage);
			var imgURL = _flaskLib.UTILITY.IMAGES_PATH + "?uuid="+generalEventDetailImg.EventDetailImage.imageUUID+"&groupId="+generalEventDetailImg.EventDetailImage.imageGroupId;
			var imgLocation = {x:xAxis, y: y, h:100, w:100};
			getImageFromUrlAndAddToPDF(imgURL,pdf,imgLocation);
			if(j+1 % 4 == 0){
				y = y + 120;
				xAxis = x + 20;
				y = checkAndAddPage(y,pdf);
			}else
				xAxis = xAxis + 120;
		}
		y= y + 120;
		y = checkAndAddPage(y,pdf);
	}
	
	if(eventCategoryDetailsArray.preEvent.length > 0){
		pdf.setFontSize(14);
		pdf.text(x,y, "Pre-Event");
		y = y+20;
	}
	for(var i = 0 ; i < eventCategoryDetailsArray.preEvent.length ; i++){
		var preEventDetailInfo = eventCategoryDetailsArray.preEvent[i];
		pdf.setFontSize(13);
		pdf.text(30, y, "("+(i+1)+") "+ preEventDetailInfo.EventDetail.infoTypeCategoryName);
		y = y + 20;
		var line = pdf.setFontSize(12).splitTextToSize("Title : " + preEventDetailInfo.EventDetail.infoTitle, 500);
		pdf.text(40, y, line);
		y = y+20;
		line = pdf.setFontSize(12).splitTextToSize("Description : " + preEventDetailInfo.EventDetail.infoDesc, 500);
		pdf.text(40, y, line);
		y = y+20;
		var xAxis = x + 20;
		y = checkAndAddPage(y,pdf);
		for(var j = 0 ; j < preEventDetailInfo.EventDetailImages.length; j++){
			var preEventDetailImg = preEventDetailInfo.EventDetailImages[j];
			preEventDetailImg.EventDetailImage = jQuery.parseJSON(preEventDetailImg.EventDetailImage);
			var imgURL = _flaskLib.UTILITY.IMAGES_PATH + "?uuid="+preEventDetailImg.EventDetailImage.imageUUID+"&groupId="+preEventDetailImg.EventDetailImage.imageGroupId;
			var imgLocation = {x:xAxis, y: y, h:100, w:100};
			getImageFromUrlAndAddToPDF(imgURL,pdf,imgLocation);
			if(j+1 % 4 == 0){
				y = y + 120;
				xAxis = x + 20;
				y = checkAndAddPage(y,pdf);
			}else
				xAxis = xAxis + 120;
		}
		y= y + 120;
		y = checkAndAddPage(y,pdf);
	}
	
	if(eventCategoryDetailsArray.postEvent.length > 0){
		pdf.setFontSize(14);
		pdf.text(x,y, "Post-Event");
		y = y+20;
	}
	for(var i = 0 ; i < eventCategoryDetailsArray.postEvent.length ; i++){
		var postEventDetailInfo = eventCategoryDetailsArray.postEvent[i];
		pdf.setFontSize(13);
		pdf.text(30, y, "("+(i+1)+") "+postEventDetailInfo.EventDetail.infoTypeCategoryName);
		y = y + 20;
		var line = pdf.setFontSize(12).splitTextToSize("Title : " + postEventDetailInfo.EventDetail.infoTitle, 500);
		pdf.text(40, y, line);
		y = y+20;
		line = pdf.setFontSize(12).splitTextToSize("Description : " + postEventDetailInfo.EventDetail.infoDesc, 500);
		pdf.text(40, y, line);
		y = y+20;
		var xAxis = x + 20;
		y = checkAndAddPage(y,pdf);
		for(var j = 0 ; j < postEventDetailInfo.EventDetailImages.length; j++){
			var postEventDetailImg = postEventDetailInfo.EventDetailImages[j];
			postEventDetailImg.EventDetailImage = jQuery.parseJSON(postEventDetailImg.EventDetailImage);
			var imgURL = _flaskLib.UTILITY.IMAGES_PATH + "?uuid="+postEventDetailImg.EventDetailImage.imageUUID+"&groupId="+postEventDetailImg.EventDetailImage.imageGroupId;
			var imgLocation = {x:xAxis, y: y, h:100, w:100};
			getImageFromUrlAndAddToPDF(imgURL,pdf,imgLocation);
			if(j+1 % 4 == 0){
				y = y + 120;
				xAxis = x + 20;
				y = checkAndAddPage(y,pdf);
			}else
				xAxis = xAxis + 120;
		}
		y= y + 120;
		y = checkAndAddPage(y,pdf);
	}
	
	if(eventCategoryDetailsArray.duringEvent.length > 0){
		pdf.setFontSize(14);
		pdf.text(x,y, "During-Event");
		y = y+20;
	}
	for(var i = 0 ; i < eventCategoryDetailsArray.duringEvent.length ; i++){
		var duringEventDetailInfo = eventCategoryDetailsArray.duringEvent[i];
		pdf.setFontSize(13);
		pdf.text(30, y, "("+(i+1)+") "+duringEventDetailInfo.EventDetail.infoTypeCategoryName);
		y = y + 20;
		var line = pdf.setFontSize(12).splitTextToSize("Title : " + duringEventDetailInfo.EventDetail.infoTitle, 500);
		pdf.text(40, y, line);
		y = y+20;
		line = pdf.setFontSize(12).splitTextToSize("Description : " + duringEventDetailInfo.EventDetail.infoDesc, 500);
		pdf.text(40, y, line);
		y = y+20;
		var xAxis = x + 20;
		y = checkAndAddPage(y,pdf);
		for(var j = 0 ; j < duringEventDetailInfo.EventDetailImages.length; j++){
			var duringEventDetailImg = duringEventDetailInfo.EventDetailImages[j];
			duringEventDetailImg.EventDetailImage = jQuery.parseJSON(duringEventDetailImg.EventDetailImage);
			var imgURL = _flaskLib.UTILITY.IMAGES_PATH + "?uuid="+duringEventDetailImg.EventDetailImage.imageUUID+"&groupId="+duringEventDetailImg.EventDetailImage.imageGroupId;
			var imgLocation = {x:xAxis, y: y, h:100, w:100};
			getImageFromUrlAndAddToPDF(imgURL,pdf,imgLocation);
			if(j+1 % 4 == 0){
				y = y + 120;
				xAxis = x + 20;
				y = checkAndAddPage(y,pdf);
			}else
				xAxis = xAxis + 120;
		}
		y= y + 120;
		y = checkAndAddPage(y,pdf);
	}
	callback(pdf);
	
}
//Check the Height of the current Content and decide to add page
function checkAndAddPage(y, pdf){
	var pageHeight = pdf.internal.pageSize.height;
	if(y > 600){
		y = 40;
		pdf.addPage();
	}
	return y;
}

// Create PDF function
function createPDF(pdf){
		pdf.save('Event_' + new Date().getTime() + '.pdf');
}

//Because of security restrictions, getImageFromUrl will
//not load images from other domains.  Chrome has added
//security restrictions that prevent it from loading images
//when running local files.  Run with: chromium --allow-file-access-from-files --allow-file-access
//to temporarily get around this issue.
var getImageFromUrlAndAddToPDF1 = function(url, pdf, callback, imgLocation) {
	var img = new Image();

	img.onError = function() {
		alert('Cannot load image: "' + url + '"');
	};
	img.onload = function() {
		pdf.addImage(img, 'JPEG', imgLocation.x, imgLocation.y, imgLocation.w, imgLocation.h, 'event');
	};
	img.src = url;
}
var getImageFromUrlAndAddToPDF = function(url, pdf, imgLocation) {
	var img = document.getElementById('eventImg');
	img.src = url;
	var canvas = document.createElement('canvas');
	var context = canvas.getContext('2d');
	context.drawImage(img, 0, 0 );
	var myData = context.getImageData(0, 0, img.width, img.height);
	pdf.addImage(img, 'JPEG', imgLocation.x, imgLocation.y, imgLocation.w, imgLocation.h, 'event');
}

//Since images are loaded asyncronously, we must wait to create
//the pdf until we actually have the image.
//If we already had the jpeg image binary data loaded into
//a string, we create the pdf without delay.
var addImageToPDF = function(imgData, pdf, imgLocation) {

	pdf.addImage(imgData, 'JPEG', imgLocation.x, imgLocation.y, imgLocation.w, imgLocation.h, 'event'); // Cache the image using the alias 'monkey'
	// As you can guess, using the cached image reduces the generated PDF size by 50%!

}
//Convert Time Format : 24 hour to AM-PM
function convert24HourToAMPM(time){
	var timeArr = time.split(":");
    var hours = timeArr[0];
    var min = timeArr[1];
    if (hours < 12) {
        if (hours === "00")
            hours = "12";
        return hours + ':' + min + ' AM';
    } else {
        hours = hours === 12 ? hours : hours - 12;
        hours = (hours < 10) ? '0' + hours : hours;
        if (hours === "00")
            hours = "12";
        return hours + ':' + min + ' PM';
    }
}